Ext.define("CMS.mask",{statics:{getGridValue:function(n,t){var i,r;if(n.length!=t.mask.viewMask.length){for(i=t.mask.viewMask,r=0;r<n.toString().length;r++)i=i.replace("_",n[n[r]]);i.length==t.mask.rawMask.length&&(n=i)}return n},returnMask:function(n){for(var o=n,u="",f=[],r=0,i="",e="",t=0;t<n.length;t++)i?(i=="X"&&(i=""),n.charAt(t)=="X"?(f[r]=i,r++,i=""):i+=n.charAt(t)):n.charAt(t)=="X"?(i+="X",u+="_"):n.charAt(t)=="9"||n.charAt(t)=="L"||n.charAt(t)=="l"||n.charAt(t)=="A"?(u+="_",f[r]=n.charAt(t),r++):(u+=n.charAt(t),f[r]=RegExp.escape(n.charAt(t)),r++);return e=u.replace(/(L|l|9|A|_|X)/g,""),{mask:n,rawMask:o,viewMask:u,maskArray:f,specialChars:e}}},constructor:function(n,t){this.clearWhenInvalid=t===undefined?!0:t;var i=CMS.mask.returnMask(n);return this.rawMask=i.mask,this.viewMask=i.viewMask,this.maskArray=i.maskArray,this.specialChars=i.specialChars,this},init:function(n){if(this.field=n,n.rendered)this.assignEl();else n.on("render",this.assignEl,this);n.on("blur",this.removeValueWhenInvalid,this);n.on("focus",this.processMaskFocus,this)},assignEl:function(){this.inputTextElement=this.field.inputEl.dom;this.field.inputEl.on("keypress",this.processKeyPress,this);this.field.inputEl.on("keydown",this.processKeyDown,this);if(Ext.isSafari||Ext.isIE){this.field.inputEl.on("paste",this.startTask,this);this.field.inputEl.on("cut",this.startTask,this)}if(Ext.isGecko||Ext.isOpera)this.field.inputEl.on("mousedown",this.setPreviousValue,this);if(Ext.isGecko)this.field.inputEl.on("input",this.onInput,this);if(Ext.isOpera)this.field.inputEl.on("input",this.onInputOpera,this)},onInput:function(){this.startTask(!1)},onInputOpera:function(){this.prevValueOpera?this.manageBackspaceAndDeleteOpera():this.startTask(!1)},manageBackspaceAndDeleteOpera:function(){this.inputTextElement.value=this.prevValueOpera.cursorPos.previousValue,this.manageTheText(this.prevValueOpera.keycode,this.prevValueOpera.cursorPos),this.prevValueOpera=null},setPreviousValue:function(){this.oldCursorPos=this.getCursorPosition()},getValidatedKey:function(n,t){var i=this.maskArray[t.start];return i=="9"?n.pressedKey.match(/[0-9]/):i=="L"?n.pressedKey.match(/[A-Za-z]/)?n.pressedKey.toUpperCase():null:i=="l"?n.pressedKey.match(/[A-Za-z]/)?n.pressedKey.toLowerCase():null:i=="A"?n.pressedKey.match(/[A-Za-z0-9]/):i?n.pressedKey.match(new RegExp(i)):null},removeValueWhenInvalid:function(){(this.clearWhenInvalid&&this.inputTextElement.value.indexOf("_")>-1||this.inputTextElement.value==this.viewMask)&&(this.inputTextElement.value="")},managePaste:function(){var n,i,t;if(this.oldCursorPos!=null){for(n=this.inputTextElement.value.substring(this.oldCursorPos.start,this.inputTextElement.value.length-(this.oldCursorPos.previousValue.length-this.oldCursorPos.end)),this.oldCursorPos.start<this.oldCursorPos.end&&(this.oldCursorPos.previousValue=this.oldCursorPos.previousValue.substring(0,this.oldCursorPos.start)+this.viewMask.substring(this.oldCursorPos.start,this.oldCursorPos.end)+this.oldCursorPos.previousValue.substring(this.oldCursorPos.end,this.oldCursorPos.previousValue.length),n=n.substr(0,this.oldCursorPos.end-this.oldCursorPos.start)),this.inputTextElement.value=this.oldCursorPos.previousValue,keycode={unicode:"",isShiftPressed:!1,isTab:!1,isBackspace:!1,isLeftOrRightArrow:!1,isDelete:!1,pressedKey:""},i=!1,t=0;t<n.length;t++){if(keycode.pressedKey=n.substr(t,1),keycode.unicode=n.charCodeAt(t),this.oldCursorPos=this.skipMaskCharacters(keycode,this.oldCursorPos),this.oldCursorPos===!1)break;this.injectValue(keycode,this.oldCursorPos)&&(i=!0,this.moveCursorToPosition(keycode,this.oldCursorPos),this.oldCursorPos.previousValue=this.inputTextElement.value,this.oldCursorPos.start=this.oldCursorPos.start+1)}i||this.oldCursorPos===!1||this.moveCursorToPosition(null,this.oldCursorPos),this.oldCursorPos=null}},processKeyDown:function(n){this.processMaskFormatting(n,"keydown")},processKeyPress:function(n){this.processMaskFormatting(n,"keypress")},startTask:function(n){this.task==undefined&&(this.task=new Ext.util.DelayedTask(this.managePaste,this)),n!==!1&&(this.oldCursorPos=this.getCursorPosition()),this.task.delay(0)},skipMaskCharacters:function(n,t){if(t.start!=t.end&&(n.isDelete||n.isBackspace))return t;while(this.specialChars.match(RegExp.escape(this.viewMask.charAt(n.isBackspace?t.start-1:t.start))))if(n.isBackspace?t.dec():t.inc(),t.start>=t.previousValue.length||t.start<0)return!1;return t},isManagedByKeyDown:function(n){return n.isDelete||n.isBackspace?!0:!1},processMaskFormatting:function(n,t){this.oldCursorPos=null;var r=this.getCursorPosition(),i=this.getKeyCode(n,t);if(i.unicode!=0&&(i.unicode!=67&&i.unicode!=99||!n.ctrlKey)){if((i.unicode==88||i.unicode==120)&&n.ctrlKey){this.startTask();return}if((i.unicode==86||i.unicode==118)&&n.ctrlKey){this.startTask();return}if((i.isBackspace||i.isDelete)&&Ext.isOpera){this.prevValueOpera={cursorPos:r,keycode:i};return}return t=="keydown"&&!this.isManagedByKeyDown(i)?!0:t=="keypress"&&this.isManagedByKeyDown(i)?!0:this.handleEventBubble(n,i,t)?!0:this.manageTheText(i,r)}},manageTheText:function(n,t){return(this.inputTextElement.value.length===0&&(this.inputTextElement.value=this.viewMask),t=this.skipMaskCharacters(n,t),t===!1)?!1:(this.injectValue(n,t)&&this.moveCursorToPosition(n,t),!1)},processMaskFocus:function(){if(this.inputTextElement.value.length==0){var n=this.getCursorPosition();this.inputTextElement.value=this.viewMask,this.moveCursorToPosition(null,n)}},isManagedByBrowser:function(n,t,i){return(i=="keypress"&&n.charCode===0||i=="keydown")&&(t.unicode==Ext.EventObject.TAB||t.unicode==Ext.EventObject.RETURN||t.unicode==Ext.EventObject.ENTER||t.unicode==Ext.EventObject.SHIFT||t.unicode==Ext.EventObject.CONTROL||t.unicode==Ext.EventObject.ESC||t.unicode==Ext.EventObject.PAGEUP||t.unicode==Ext.EventObject.PAGEDOWN||t.unicode==Ext.EventObject.END||t.unicode==Ext.EventObject.HOME||t.unicode==Ext.EventObject.LEFT||t.unicode==Ext.EventObject.UP||t.unicode==Ext.EventObject.RIGHT||t.unicode==Ext.EventObject.DOWN)?!0:!1},handleEventBubble:function(n,t,i){try{return t&&this.isManagedByBrowser(n,t,i)?!0:(n.stopEvent(),!1)}catch(r){alert(r.message)}},getCursorPosition:function(){var t,i,n;return this.inputTextElement.createTextRange?(n=document.selection.createRange().duplicate(),n.moveEnd("character",this.inputTextElement.value.length),t=n.text===""?this.inputTextElement.value.length:this.inputTextElement.value.lastIndexOf(n.text),n=document.selection.createRange().duplicate(),n.moveStart("character",-this.inputTextElement.value.length),i=n.text.length):(t=this.inputTextElement.selectionStart,i=this.inputTextElement.selectionEnd),this.CursorPosition(t,i,n,this.inputTextElement.value)},moveCursorToPosition:function(n,t){var i=!n||n&&n.isBackspace?t.start:t.start+1;this.inputTextElement.createTextRange?(t.range.move("character",i),t.range.select()):(this.inputTextElement.selectionStart=i,this.inputTextElement.selectionEnd=i)},injectValue:function(n,t){if(!n.isDelete&&n.unicode==t.previousValue.charCodeAt(t.start))return!0;var i;return(n.isDelete||n.isBackspace?t.start==t.end?(i="_",n.isBackspace&&t.dec()):i=this.viewMask.substring(t.start,t.end):i=this.getValidatedKey(n,t),i)?(this.inputTextElement.value=t.previousValue.substring(0,t.start)+i+t.previousValue.substring(t.start+i.length,t.previousValue.length),!0):!1},getKeyCode:function(n,t){var i={};return i.unicode=n.getKey(),i.isShiftPressed=n.shiftKey,i.isDelete=n.getKey()==Ext.EventObject.DELETE&&t=="keydown"||t=="keypress"&&n.charCode===0&&n.keyCode==Ext.EventObject.DELETE?!0:!1,i.isTab=n.getKey()==Ext.EventObject.TAB?!0:!1,i.isBackspace=n.getKey()==Ext.EventObject.BACKSPACE?!0:!1,i.isLeftOrRightArrow=n.getKey()==Ext.EventObject.LEFT||n.getKey()==Ext.EventObject.RIGHT?!0:!1,i.pressedKey=String.fromCharCode(i.unicode),i},CursorPosition:function(n,t,i,r){var u={};return u.start=isNaN(n)?0:n,u.end=isNaN(t)?0:t,u.range=i,u.previousValue=r,u.inc=function(){u.start++,u.end++},u.dec=function(){u.start--,u.end--},u},getValue:function(n,t){var u,i,r;if(t.saveMask===!0)return n;for(u=this.specialChars+"_",i=0;i<u.length;i++)for(r=u[i];n.toString().indexOf(r)!=-1;)n=n.toString().replace(r,"");return n==this.viewMask?"":n},removeMask:function(){var n=this,t=n.field;t.un("render",n.assignEl,n),t.un("blur",n.removeValueWhenInvalid,n),t.un("focus",n.processMaskFocus,n),t.inputEl.un("keypress",n.processKeyPress,n),t.inputEl.un("keydown",n.processKeyDown,n),(Ext.isSafari||Ext.isIE)&&(t.inputEl.un("paste",n.startTask,n),t.inputEl.un("cut",n.startTask,n)),(Ext.isGecko||Ext.isOpera)&&t.inputEl.un("mousedown",n.setPreviousValue,n),Ext.isGecko&&t.inputEl.un("input",n.onInput,n),Ext.isOpera&&t.inputEl.un("input",n.onInputOpera,n),Ext.isArray(t.plugins)?Ext.Array.remove(t.plugins,n):t.plugins=null},isValid:function(){return!(this.inputTextElement.value.indexOf("_")>-1)}}),Ext.applyIf(RegExp,{escape:function(n){return new String(n).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")}})